<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Look Up</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Adamina&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QZX0VTWYMP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QZX0VTWYMP');
    </script>
    
    <style>
        body {
            font-family: 'Adamina', serif;
            margin: 0;
            padding: 0;
            text-align: left;
            background-color: #f4f4f4;
            color: #1e3565;
            line-height: 1.6;
            width: 100%;
        }
        h1 {
            color: #1e3565;
            margin-bottom: 30px;
            font-weight: bold;
        }
        select, button {
            font-family: 'Adamina', serif;
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            max-width: 300px;
            border: 1px solid #1e3565;
            border-radius: 4px;
            color: #1e3565;
        }
        button {
            background-color: #9acf8c;
            color: #1e3565;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #7bb56f;
            transform: scale(1.05);
        }
        table {
            width: 100%;
            max-width: 600px;
            margin: auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(30, 53, 101, 0.1);
        }
        table, th, td {
            border: 1px solid #1e3565;
            text-align: left;
        }
        th {
            background-color: #1e3565;
            color: white;
            font-weight: bold;
        }
        .form-link {
            color: #1e3565;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .form-link:hover {
            color: #9acf8c;
            text-decoration: underline;
        }
        #output {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(30, 53, 101, 0.1);
            color: #1e3565;
            width: 100%;
            max-width: 1800px;
        }
        .section-header {
            color: #1e3565;
            margin-top: 15px;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .feedback-section {
            background-color: #f9f9f9;
            border-radius: 1px;
        }
        .dropdown-container {
            display: flex; /* Align items horizontally */
            justify-content: center; /* Center the items */
            gap: 20px; /* Space between dropdowns */
            margin-bottom: 0px;
        }

        .dropdown-item {
            display: flex; /* Align label and dropdown horizontally */
            align-items: center; /* Vertically center label and dropdown */
            gap: 10px; /* Space between label and dropdown */
        }

        .checkbox-container {
            display: flex; /* Align items horizontally */
            justify-content: center; /* Center the items */
            gap: 20px; /* Space between dropdowns */
            margin-bottom: 20px;
        }

        .checkbox-container label {
            font-weight: bold; /* Make text bold */
            margin: 0;
            padding: 0;
        }

        select {
            padding: 10px;
            font-family: 'Adamina', serif;
            border: 1px solid #1e3565;
            border-radius: 4px;
            color: #1e3565;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            select, button {
                max-width: 100%;
            }
            table {
                font-size: 14px;
            }
        }
        .phone-submission {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #9acf8c;
        }

        .phone-input {
            font-family: 'Adamina', serif;
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 300px;
            border: 1px solid #1e3565;
            border-radius: 4px;
            color: #1e3565;
            font-size: 16px; /* Make the font size larger for better readability */
            letter-spacing: 0.5px; /* Add slight spacing between characters */
        }

        .phone-input::placeholder {
            color: #999;
        }

        .success-message {
            color: #7bb56f;
            margin-top: 10px;
            font-weight: bold;
        }

        .error-message {
            color: #ff6b6b;
            margin-top: 10px;
            font-weight: bold;
        }

        .content-wrapper {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }

        .left-section {
            flex: 1;
            max-width: 50%;
            text-align: left;
        }

        .right-section {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
        }

        .table-container {
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow-y: auto;
            max-height: 660px; /* Set a max height that matches left content */
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th {
            background-color: #1e3565;
            color: white;
            font-weight: bold;
            padding: 12px;
            text-align: left;
            border: none;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            background-color: white;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Style the scrollbar */
        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #9acf8c;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #7bb56f;
        }

        @media (max-width: 900px) {
            .content-wrapper {
                flex-direction: column;
            }
            .left-section, .right-section {
                max-width: 100%;
            }
        }

        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }

        .header {
            width: 100%;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(24px, 3vw, 48px); /* Minimum 24px, Maximum 48px, scales with viewport */
            margin: 0;
            padding-top: 20px;
        }

        .main-content {
            display: flex;
            gap: 20px;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .left-column {
            width: 20%;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .filters {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(30, 53, 101, 0.1);
        }

        .filter-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        .results {
            flex: 1;
            min-height: 300px; /* Match height of left column */
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(30, 53, 101, 0.1);
            position: relative; /* Add this to make absolute positioning work */
        }

        /* Make both main containers have same minimum height */
        .filters, .results {
            min-height: 300px;
        }

        .content-wrapper {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%;
        }

        .left-section, 
        .right-section {
            flex: 1;
            height: 100%;
        }

        .table-container {
            width: 100%;
            overflow-y: auto;
            flex: 1;
        }

        /* Improve mobile responsiveness */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 10px;
            }

            .left-column {
                width: 100%;
                min-width: auto;
            }
            
            .results {
                width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            
            .content-wrapper {
                flex-direction: column;
            }
            
            .left-section, 
            .right-section {
                max-width: 100%;
            }
            
            table {
                width: 100%;
                font-size: 14px;
            }
            
            .table-container {
                max-width: 100%;
                overflow-x: auto;
            }
            
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                overflow-x: hidden;
            }
            
            .page-container {
                width: 100%;
                overflow-x: hidden;
            }
            
            select, button, .phone-input {
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
        }

        .feedback-section {
            padding-left: 20px;
            padding-right: 20px;
            padding-top: 5px;
            padding-bottom: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(30, 53, 101, 0.1);
        }

        .form-link {
            color: #1e3565;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .form-link:hover {
            color: #9acf8c;
            text-decoration: underline;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1e3565;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #1e3565;
            font-weight: bold;
            margin-top: 10px;
        }

        .filter-toggle {
            margin-bottom: 10px;
            font-weight: bold;
            color: #1e3565;
        }
        
        .filter-toggle input[type="checkbox"] {
            margin-right: 5px;
        }
        
        tr[data-pcp-eligible="true"] {
            background-color: #f0f7ee;
        }

        /* Add these styles to your existing CSS */
        .button-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
    <script>
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let phoneNumber = input.replace(/\D/g, '');
            
            // Limit to 10 digits
            phoneNumber = phoneNumber.substring(0, 10);
            
            // Format the number as (XXX) XXX-XXXX
            if (phoneNumber.length > 0) {
                if (phoneNumber.length <= 3) {
                    phoneNumber = `(${phoneNumber}`;
                } else if (phoneNumber.length <= 6) {
                    phoneNumber = `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3)}`;
                } else {
                    phoneNumber = `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6)}`;
                }
            }
            
            return phoneNumber;
        }

        // Add event listener to format phone number as user types
        function setupPhoneNumberFormatting() {
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let formattedNumber = formatPhoneNumber(e.target.value);
                    e.target.value = formattedNumber;
                });
            }
        }

        // Modify the submitPhoneNumber function to show a loading spinner
        async function submitPhoneNumber(insurance) {
            // Track the phone submission in Google Analytics
            gtag('event', 'text_message_sent', {
                'event_category': 'Engagement',
                'event_label': `Text Message - ${insurance}`
            });
            
            const phoneNumber = document.getElementById("phoneNumber").value;
            const submitButton = event.target; // Get the button that was clicked
            const originalButtonText = submitButton.innerHTML;
            
            // Disable the button and show loading spinner
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <div class="button-spinner"></div>
                Sending...
            `;
            
            try {
                const response = await fetch('/submit-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        insurance: insurance
                    })
                });
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="error-message">${data.error}</div>`;
                } else {
                    document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="success-message">Text message sent successfully!</div>`;
                }
            } catch (error) {
                document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="error-message">Failed to send text message</div>`;
            } finally {
                // Re-enable the button and restore original text
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        // Add this function to check if PCP change is not needed
        function isPCPChangeNotNeeded(insurance) {
            const noPCPChangeInsurances = [
                "Aetna Commercial", "OPEN ACCESS AETNA SELECT", "AETNA CHOICE POS II", 
                "OPEN ACCESS ELECT CHOICE (OAEPO)", "United Teamster Fund", "UMR",
                "Quantum Health", "AMERICAN AIRLINES - UHC CHOICE PLUS", "UNITED WELFARE FUND",
                "UHC CHOICE PLUS", "BLUE CROSS BLUE SHIELD", "BLUE ACCESS PPO NY",
                "NJ PPO ALTNET HORIZON MAN CARE 36K0", "EPO Plan", 
                "Empire Blue Access Gated EPO", "FEP BLUE/FEDERAL",
                "Oxford Health Plan", "Liberty Network Plan", "Freedom Network",
                "Oscar Health", "PPO", "EPO", "United Healthcare", "Choice Plus",
                "LPPO-UNITEDHEALTHCARE GROUP MEDICARE ADVANTAGE", 
                "UHC Dual Complete NY-S001 (PPO D-SNP)", "Choice", "Choice EPO",
                "WELLCARE", "SIMPLE OPEN (PPO)"
            ];
            
            return noPCPChangeInsurances.some(ins => insurance.includes(ins));
        }

        // Modify the fetchWithRetry function to handle retries more gracefully
        async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 1000) {
            let lastError;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fetch(url, options);
                } catch (error) {
                    console.log(`Fetch attempt ${attempt + 1} failed:`, error);
                    lastError = error;
                    
                    // Wait before retrying
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            // If we've exhausted all retries, throw the last error
            throw lastError;
        }

        // Add a function to get Member Services number based on insurance
        function getMemberServicesNumber(insurance) {
            const memberServicesMap = {
                "Centivo": "866-355-5999",
                "Oscar Health": "855-672-2755",
                "Emblem Health-GHI": "(800) 624-2414",
                "Magnacare": "(888) 799-6465",
                "Emblem Health HIP": "(800) 447-8255"
            };
            
            // Check if the insurance exists in our mapping
            for (const [insName, number] of Object.entries(memberServicesMap)) {
                if (insurance.includes(insName)) {
                    return number;
                }
            }
            
            // Default message if no match is found
            return "Please check the back of the Patient's Insurance ID card";
        }

        // Function to check if a provider is PCP eligible (temporarily disabled)
        function isPcpEligible(providerName, location, insurance) {
            // DISABLED: Hardcoded mapping for PCP eligibility
            /*
            const pcpEligibilityMap = {
                "Crown Heights": {
                    "Healthfirst Medicare": ["Max Rubin", "Nickecha Redway", "Dayakishan Chahal"]
                }
                // Add more locations and insurances as needed
            };
            
            // Check if we have data for this location and insurance
            if (pcpEligibilityMap[location] && 
                pcpEligibilityMap[location][insurance]) {
                // Return true if the provider is in the eligible list
                return pcpEligibilityMap[location][insurance].includes(providerName);
            }
            */
            
            // Default to showing all providers while feature is disabled
            return true;
        }

        // Modify the provider options HTML generation to include a disabled filter toggle
        function createProviderOptionsHTML(data, site, insurance) {
            // Create a disabled checkbox for filtering (feature coming soon)
            const filterCheckboxHTML = `
                <!-- PCP Eligibility filter temporarily disabled
                <div class="filter-toggle">
                    <label>
                        <input type="checkbox" id="pcpEligibleOnly" onchange="filterProviderTable()" disabled>
                        Show only PCP-eligible providers (Coming soon)
                    </label>
                </div>
                -->
            `;
            
            // Create the table with all providers
            return `
                <div class="right-section">
                    <div class="section-header">Provider Options</div>
                    ${filterCheckboxHTML}
                    <div class="table-container">
                        <table id="providerTable">
                            <thead>
                                <tr>
                                    <th>Provider Name</th>
                                    <th>${insurance.toLowerCase().indexOf('healthfirst') !== -1 ? "Healthfirst ID" : "Provider NPI"}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.provider_options.map((provider) => `
                                    <tr data-pcp-eligible="true">
                                        <td>${provider.name}</td>
                                        <td>${provider.npi}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Filter provider table function (temporarily disabled)
        function filterProviderTable() {
            // DISABLED: Filtering functionality
            /*
            const showOnlyEligible = document.getElementById("pcpEligibleOnly").checked;
            const rows = document.querySelectorAll("#providerTable tbody tr");
            
            rows.forEach(row => {
                const isEligible = row.getAttribute("data-pcp-eligible") === "true";
                row.style.display = (showOnlyEligible && !isEligible) ? "none" : "";
            });
            */
        }

        // Modify the fetchOptions function to include Aetna information
        async function fetchOptions() {
            const site = document.getElementById("site").value;
            const insurance = document.getElementById("insurance").value;
            const isUnder18 = document.getElementById("isUnder18").checked;
            const isFollowUp = document.getElementById("isFollowUp").checked;

            if (!site || !insurance) {
                alert("Please select both site and insurance!");
                return;
            }

            // Show loading spinner
            document.getElementById("output").innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Retreiving information and Providers...</div>
                </div>
            `;

            // Predefined response for "OTHER" insurance
            if (insurance === "OTHER") {
                const predefinedOtherResponse = {
                    facility_options: {
                        facilities: [],
                        message: "Unable to determine facility options."
                    },
                    pcp_change_requirement: {
                        details: "Insurance not in our current system."
                    },
                    feedback_link: "https://forms.gle/ME2mKmVALXh4iDKWA"
                };

                const outputHTML = `
                    <div class="section-header">Insurance Inquiry</div>
                    <p>${predefinedOtherResponse.pcp_change_requirement.details}</p>
                    
                    <div class="feedback-section">
                        <div class="section-header">Next Steps</div>
                        <p>We recommend calling the Member Services number on the back of the patient's insurance card.</p>
                        
                        <div class="section-header">Help Us Improve</div>
                        <p>Can't find your insurance?</p>
                        <p>We want to hear from you!</p>
                        <a href="${predefinedOtherResponse.feedback_link}" 
                        target="_blank" 
                        class="form-link">
                        Submit Feedback
                        </a>
                    </div>
                `;

                document.getElementById("output").innerHTML = outputHTML;
                return; // Stop further execution
            }

            try {
                const response = await fetchWithRetry(
                    `/test?location=${encodeURIComponent(site)}&insurance=${encodeURIComponent(insurance)}&isUnder18=${isUnder18}&isFollowUp=${isFollowUp}`,
                    {},  // default options
                    3,   // max 3 retries
                    1000 // 1 second delay between retries
                );
                
                const data = await response.json();

                if (data.error) {
                    document.getElementById("output").innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }

                // Add PCP Change section with additional insurance-specific information if applicable
                let pcpChangeHTML = '';
                if (!isUnder18 && data.pcp_change_requirement) {
                    const requiresThreeWayCall = data.pcp_change_requirement.details && 
                        data.pcp_change_requirement.details.includes("3-way call required");
                    
                    // Start with the standard PCP change requirement information
                    pcpChangeHTML = `
                        <div class="section-header">PCP Change Requirement</div>
                        <p>${data.pcp_change_requirement.details}</p>
                        
                        ${requiresThreeWayCall ? `
                            <p><strong>Member Services Number:</strong> ${getMemberServicesNumber(insurance)}</p>
                        ` : ''}
                    `;
                    
                    // Add Medicare-specific or form-specific information
                    if (insurance === "Medicare") {
                        pcpChangeHTML += `
                            <div class="section-header">PCP Change Form</div>
                            <p>
                                • If you want to send Healow Sign, 
                                <a href="https://docs.google.com/presentation/d/1VyVUQb-XBqmuwI4JGZyYN_3zwZD0O-SYDb6V16E6DcY/edit#slide=id.g3086a10fc51_0_189" 
                                target="_blank" 
                                class="form-link">
                                click here for Healow Sign Process
                                </a>
                            </p>
                            <p>If you want to print out the required forms, you can access them below:</p>
                            <p>
                                • <a href="https://drive.google.com/file/d/1YI4b9ZOTKDTM0SsGLJzytdTO24zTNE2E/view?usp=drive_link" 
                                target="_blank" 
                                class="form-link">
                                Voluntary Alignment Form
                                </a>
                            </p>
                            <p>
                                • <a href="https://drive.google.com/file/d/1LbekCRNLZsXzzNdXS0edFVZCmjNZwnA5/view?usp=sharing" 
                                target="_blank" 
                                class="form-link">
                                SDoH Form
                                </a>
                            </p>
                        `;
                    } else if (data.pcp_change_requirement?.form_link) {
                        pcpChangeHTML += `
                            <div class="phone-submission">
                                <p>If you want to send the 
                                    <a href="https://checkin.naomedical.com"
                                    target="_blank" 
                                    class="form-link">PCP Change Portal Link
                                    </a>       
                                    to the patient, please enter their phone number below,
                                </p>
                                <input type="tel" id="phoneNumber" class="phone-input" 
                                    placeholder="(XXX) XXX-XXXX"
                                    maxlength="14">
                                <button onclick="submitPhoneNumber('${insurance}')">Submit</button>
                                <div id="phoneSubmissionMessage"></div>
                            </div>
                            <p>
                                • If you want to send Healow Sign, 
                                <a href="https://docs.google.com/presentation/d/1VyVUQb-XBqmuwI4JGZyYN_3zwZD0O-SYDb6V16E6DcY/edit#slide=id.g3086a10fc51_0_189" 
                                target="_blank" 
                                class="form-link">
                                click here for Healow Sign Process
                                </a>
                            </p>
                            <p>
                                • If you want to print out the form, 
                                <a href="${data.pcp_change_requirement.form_link}" 
                                target="_blank" 
                                class="form-link">
                                click here to access PCP Change Form
                                </a>
                            </p>
                        `;
                    }
                    
                    // Add United Healthcare specific information if applicable
                    if (insurance.includes("UHC") || insurance.includes("United Healthcare")) {
                        pcpChangeHTML += `
                            <div class="section-header">Line of Business that do not need PCP Change.</div>
                            <ul style="text-align: left; padding-left: 20px;">
                                <li>Choice Plus</li>
                                <li>LPPO-UNITEDHEALTHCARE GROUP MEDICARE ADVANTAGE</li>
                                <li>UHC Dual Complete NY-S001 (PPO D-SNP)</li>
                                <li>POS Choice Plus</li>
                                <li>Choice EPO</li>
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        `;
                    }
                    
                    // Add Oxford specific information if applicable
                    if (insurance.includes("Oxford")) {
                        pcpChangeHTML += `
                            <div class="section-header">Line of Business that do not need PCP Change.</div>
                            <ul style="text-align: left; padding-left: 20px;">
                                <li>Liberty Network</li>
                                <li>Freedom Network</li>
                            </ul>
                        `;
                    }
                    
                    // Add Aetna specific information if applicable
                    if (insurance.includes("Aetna")) {
                        pcpChangeHTML += `
                            <div class="section-header">Line of Business that do not need PCP Change.</div>
                            <ul style="text-align: left; padding-left: 20px;">
                                <li>OPEN ACCESS AETNA SELECT</li>
                                <li>OPEN ACCESS MANAGED CHOICE (MC)</li>
                                <li>AETNA CHOICE POS II</li>
                                <li>OPEN ACCESS ELECT CHOICE (OAEPO)</li>
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        `;
                    }
                }

                // Use the new function to create provider options HTML
                const providerOptionsHTML = createProviderOptionsHTML(data, site, insurance);
                
                document.getElementById("output").innerHTML = `
                    <div class="content-wrapper">
                        <div class="left-section">
                            <div class="section-header">Facility Options</div>
                            ${data.facility_options.message}
                            
                            ${pcpChangeHTML}
                        </div>
                        ${providerOptionsHTML}
                    </div>
                `;
                
                // Setup phone formatting after content is added
                setTimeout(setupPhoneNumberFormatting, 100);
            } catch (error) {
                console.error("Error fetching data after multiple retries:", error);
                document.getElementById("output").innerHTML = `
                    <div class="error-message">
                        An error occurred while fetching data. 
                        <button onclick="fetchOptions()" class="retry-button">Retry</button>
                    </div>`;
            }
        }

        function handleSubmit() {
            // Track the button click in Google Analytics
            gtag('event', 'button_click', {
                'event_category': 'Engagement',
                'event_label': 'Submit Button'
            });
            
            // Call the original function
            fetchOptions();
        }
    </script>
</head>
<body>
    <div class="page-container">
        <div class="header">
            <h1>Provider Look Up Tool</h1>
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="filters">
                    <div class="filter-group">
                        <label>Location:</label>
                        <select id="site">
                            <option value="">Select Location</option>
                            <option value="Astoria">Astoria</option>
                            <option value="Bartow">Bartow</option>
                            <option value="BX174">BX174</option>
                            <option value="Corona">Corona</option>
                            <option value="Crown Heights">Crown Heights</option>
                            <option value="Hicksville">Hicksville</option>
                            <option value="Jackson Heights">Jackson Heights</option>
                            <option value="Jamaica">Jamaica</option>
                            <option value="LIC">Long Island City</option>
                            <option value="Manhattan">Manhattan</option>
                            <option value="Mineola">Mineola</option>
                            <option value="Stuytown">Stuytown</option>
                            <option value="Williamsburg">Williamsburg</option>
                            <option value="Nutrition">Nao Med - Nutrition</option>
                            <option value="PSYCH">Nao Med - Psych</option>
                            <option value="Televisit">Televisit</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Insurance:</label>
                        <select id="insurance">
                            <option value="">Select Insurance</option>
                            <option value="1199 National Benefits Fund">1199 National Benefits Fund</option>
                            <option value="Aetna">Aetna</option>
                            <option value="BC Empire">BC Empire</option>
                            <option value="BCBS Empire">BCBS Empire</option>
                            <option value="Centivo">Centivo</option>
                            <option value="Cigna">Cigna</option>
                            <option value="Elder Plan">Elder Plan</option>
                            <option value="Emblem Health-GHI">Emblem Health-GHI</option>
                            <option value="Emblem Health HIP">Emblem Health HIP</option>
                            <option value="Fidelis">Fidelis</option>
                            <option value="First Health (Aetna)">First Health (Aetna)</option>
                            <option value="Healthfirst Medicare">Healthfirst Medicare</option>
                            <option value="Healthfirst Medicaid">Healthfirst Medicaid</option>
                            <option value="Healthfirst Other LOB">Healthfirst Other LOB</option>
                            <option value="HEALTHPLUS LLC">HEALTHPLUS LLC</option>
                            <option value="Humana">Humana</option>
                            <option value="Magnacare">Magnacare</option>
                            <option value="Medicaid">Medicaid</option>
                            <option value="Medicare">Medicare</option>
                            <option value="Metroplus">Metroplus</option>
                            <option value="Affinity">Molina Affinity</option>
                            <option value="MVP Health Plan">MVP Health Plan</option>
                            <option value="Multiplan / PHCS">Multiplan / PHCS</option>
                            <option value="Oscar Health">Oscar Health</option>
                            <option value="Oxford">Oxford Health Plan</option>
                            <option value="Tricare Humana Military">Tricare Humana Military</option>
                            <option value="UHC Medicare">United Healthcare Medicare</option>
                            <option value="UHC Medicaid NY">United Healthcare Medicaid NY</option>
                            <option value="UHC other LOB">United Healthcare other LOB</option>
                            <option value="WEBTPA">WEBTPA</option>
                            <option value="Wellcare">Wellcare</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="isUnder18">
                            Is patient under the age of 18?
                        </label>
                    </div>
                    
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="isFollowUp">
                            Is this a follow-up appointment?
                        </label>
                    </div>
                    
                    <button onclick="handleSubmit()">Submit</button>
                </div>

                <div class="feedback-section">
                    <div class="section-header">Help Us Improve</div>
                    <p>Can't find the insurance or provider you're looking for? We want to hear from you!</p>
                    <a href="https://forms.gle/ME2mKmVALXh4iDKWA" 
                       target="_blank" 
                       class="form-link">
                       Submit Feedback
                    </a>
                </div>
            </div>

            <div class="results" id="output">
                <!-- This content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>
