<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Look Up</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Adamina&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QZX0VTWYMP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QZX0VTWYMP');
    </script>
    
    <style>
        body {
            font-family: 'Inter', 'Adamina', sans-serif;
            margin: 0;
            padding: 0;
            text-align: left;
            background-color: rgb(245 251 244); /* Updated background color */
            color: #2c3e50;
            line-height: 1.7;
            width: 100%;
        }
        h1 {
            color: #1e3565;
            margin-bottom: 5px;
            font-weight: 700;
            font-size: 2.5rem;
        }
        select, button, input {
            font-family: 'Inter', 'Adamina', sans-serif;
            padding: 12px;
            width: 100%;
            max-width: 300px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            color: #2c3e50;
            transition: all 0.3s ease;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1e3565;
            box-shadow: 0 0 0 3px rgba(30, 53, 101, 0.1);
        }
        button {
            background-color: #1e3565;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        button:hover {
            background-color: #2a4980;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            max-width: 600px;
            margin: auto;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        table, th, td {
            border: none;
            text-align: left;
        }
        th {
            background-color: #1e3565;
            color: white;
            font-weight: 600;
            padding: 15px;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .form-link {
            color: #3182ce;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 1px solid transparent;
            padding-bottom: 2px;
        }
        .form-link:hover {
            color: #2c5282;
            border-bottom: 1px solid #2c5282;
        }
        #output {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            color: #2c3e50;
            width: 100%;
            max-width: 1800px;
        }
        .section-header {
            color: #1e3565;
            margin-top: 15px;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #edf2f7;
        }
        .feedback-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }
        .dropdown-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 15px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            margin-right: 10px;
            width: auto;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            text-align: left;
        }
        
        .filter-group label.select-label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-group select, 
        .filter-group input[type="text"] {
            width: 100%;
            margin: 0;
        }
        
        button[type="submit"],
        button.submit-button {
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            select, button {
                max-width: 100%;
            }
            table {
                font-size: 14px;
            }
        }
        .phone-submission {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .phone-input {
            font-family: 'Inter', 'Adamina', sans-serif;
            padding: 12px;
            margin: 12px 0;
            width: 100%;
            max-width: 300px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            color: #2c3e50;
            font-size: 16px;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .phone-input::placeholder {
            color: #a0aec0;
        }

        .success-message {
            color: #38a169;
            margin-top: 12px;
            font-weight: 600;
            padding: 10px;
            background-color: #f0fff4;
            border-radius: 4px;
        }

        .error-message {
            color: #e53e3e;
            margin-top: 12px;
            font-weight: 600;
            padding: 10px;
            background-color: #fff5f5;
            border-radius: 4px;
        }

        .content-wrapper {
            display: flex;
            gap: 30px;
            align-items: stretch;
            margin-top: 15px;
        }

        .left-section {
            flex: 1;
            max-width: 50%;
            text-align: left;
            margin-left: 15px;
            padding-top: 0px;
            padding-left: 25px;
            padding-right: 25px;
            padding-bottom: 25px;
        }

        .right-section {
            flex: 1;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            background: white;
            padding-top: 0px;
            padding-left: 25px;
            padding-right: 25px;
            padding-bottom: 25px;
            margin-bottom: 20px;
            margin-right: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .table-container {
            margin-top: 15px;
            border: 1px solid #edf2f7;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 710px; /* Dynamic height based on viewport */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th {
            background-color: #1e3565;
            color: white;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border: none;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            background-color: white;
        }

        /* Style the scrollbar */
        .table-container::-webkit-scrollbar {
            width: 10px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 6px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        @media (max-width: 900px) {
            .content-wrapper {
                flex-direction: column;
            }
            .left-section, .right-section {
                max-width: 100%;
                margin-bottom: 20px;
            }
        }

        .page-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 15px 25px;
        }

        .header-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: fit-content;
            margin: 0 auto;
        }

        .header-logo {
            height: 50px;
            margin-bottom: 10px;
            display: block;
        }
        
        .header-title {
            font-size: clamp(24px, 1.95vw, 36px);
            margin: 0;
            padding: 0;
            color: #0a1c3e; /* Darker blue color */
            text-align: center;
            font-weight: 700;
            line-height: 1.2;
            width: auto;
            max-width: 100%;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .left-column {
            width: 25%;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .filters {
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .filter-group {
            display: flex;
            margin-bottom: 10px;
            text-align: left;
        }

        .filter-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            margin: 0;
        }
        
        /* Label for select elements */
        .select-label {
            display: block;
            text-align: left;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .results {
            flex: 1;
            min-height: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Make both main containers have same minimum height */
        .filters, .results {
            min-height: 200px;
        }

        /* Improve mobile responsiveness */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 10px;
            }

            .left-column {
                width: 100%;
                min-width: auto;
            }
            
            .results {
                width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            
            .content-wrapper {
                flex-direction: column;
            }
            
            .left-section, 
            .right-section {
                max-width: 100%;
            }
            
            table {
                width: 100%;
                font-size: 14px;
            }
            
            .table-container {
                max-width: 100%;
                overflow-x: auto;
            }
            
            body {
                padding: 0;
                margin: 0;
                width: 100%;
                overflow-x: hidden;
            }
            
            .page-container {
                width: 100%;
                overflow-x: hidden;
                padding: 10px;
            }
            
            select, button, .phone-input {
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
        }

        .feedback-section {
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
            text-align: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1e3565;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #1e3565;
            font-weight: 600;
            margin-top: 15px;
        }

        .filter-toggle {
            color: #1e3565;
            display: flex;
            align-items: center;
        }
        
        .filter-toggle input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }
        
        tr[data-pcp-eligible="true"] {
            background-color: #f0f7ee;
        }

        /* Add these styles to your existing CSS */
        .button-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* New styles for improved design */
        .divider {
            height: 1px;
            background-color: #e2e8f0;
            margin: 20px 0;
            width: 100%;
        }
        
        ul {
            padding-left: 25px;
            margin: 15px 0;
        }
        
        ul li {
            margin-bottom: 8px;
        }
        
        /* Provider search filter */
        .provider-search {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-family: 'Inter', 'Adamina', sans-serif;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        /* Button styling for links that should look like buttons */
        .button-link {
            display: inline-block;
            padding: 10px 15px;
            background-color: #1e3565;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            margin: 10px 0;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .button-link:hover {
            background-color: #2a4980;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: white;
            text-decoration: none;
        }
        
        /* Card styling for sections */
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #1e3565;
        }

        /* Remove top margin from paragraphs in specific sections */
        .left-section p, 
        .phone-submission p,
        .feedback-section p {
            margin-top: 0;
            margin-block-start: 0;
        }
        
        /* Keep bottom margin for spacing between paragraphs */
        .left-section p:not(:last-child),
        .phone-submission p:not(:last-child),
        .feedback-section p:not(:last-child) {
            margin-bottom: 1em;
            margin-block-end: 1em;
        }

        /* Adjust spacing for form links */
        .left-section p + p {
            margin-top: 5px;
        }
        
        /* First paragraph after a section header or div gets normal top margin */
        .section-header + p,
        .phone-submission + p {
            margin-top: 15px;
        }

        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            width: 100%;
        }
        
        .error-message {
            color: #e53e3e;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .retry-button {
            background-color: #1e3565;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .retry-button:hover {
            background-color: #2a4980;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let phoneNumber = input.replace(/\D/g, '');
            
            // Limit to 10 digits
            phoneNumber = phoneNumber.substring(0, 10);
            
            // Format the number as (XXX) XXX-XXXX
            if (phoneNumber.length > 0) {
                if (phoneNumber.length <= 3) {
                    phoneNumber = `(${phoneNumber}`;
                } else if (phoneNumber.length <= 6) {
                    phoneNumber = `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3)}`;
                } else {
                    phoneNumber = `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6)}`;
                }
            }
            
            return phoneNumber;
        }

        // Add event listener to format phone number as user types
        function setupPhoneNumberFormatting() {
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let formattedNumber = formatPhoneNumber(e.target.value);
                    e.target.value = formattedNumber;
                });
            }
        }

        // Modify the submitPhoneNumber function to show a loading spinner
        async function submitPhoneNumber(insurance) {
            // Track the phone submission in Google Analytics
            gtag('event', 'text_message_sent', {
                'event_category': 'Engagement',
                'event_label': `Text Message - ${insurance}`
            });
            
            const phoneNumber = document.getElementById("phoneNumber").value;
            const submitButton = event.target; // Get the button that was clicked
            const originalButtonText = submitButton.innerHTML;
            
            // Disable the button and show loading spinner
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <div class="button-spinner"></div>
                Sending...
            `;
            
            try {
                const response = await fetch('/submit-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        insurance: insurance
                    })
                });
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="error-message">${data.error}</div>`;
                } else {
                    document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="success-message">Text message sent successfully!</div>`;
                }
            } catch (error) {
                document.getElementById("phoneSubmissionMessage").innerHTML = `<div class="error-message">Failed to send text message</div>`;
            } finally {
                // Re-enable the button and restore original text
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }

        // Add this function to check if PCP change is not needed
        function isPCPChangeNotNeeded(insurance) {
            const noPCPChangeInsurances = [
                "Aetna Commercial", "OPEN ACCESS AETNA SELECT", "AETNA CHOICE POS II", 
                "OPEN ACCESS ELECT CHOICE (OAEPO)", "United Teamster Fund", "UMR",
                "Quantum Health", "AMERICAN AIRLINES - UHC CHOICE PLUS", "UNITED WELFARE FUND",
                "UHC CHOICE PLUS", "BLUE CROSS BLUE SHIELD", "BLUE ACCESS PPO NY",
                "NJ PPO ALTNET HORIZON MAN CARE 36K0", "EPO Plan", 
                "Empire Blue Access Gated EPO", "FEP BLUE/FEDERAL",
                "Oxford Health Plan", "Liberty Network", "Freedom Network",
                "Oscar Health", "PPO", "EPO", "United Healthcare", "Choice Plus",
                "LPPO-UNITEDHEALTHCARE GROUP MEDICARE ADVANTAGE", 
                "UHC Dual Complete NY-S001 (PPO D-SNP)", "Choice", "Choice EPO",
                "WELLCARE", "SIMPLE OPEN (PPO)"
            ];
            
            return noPCPChangeInsurances.some(ins => insurance.includes(ins));
        }

        // Modify the fetchWithRetry function to handle database spin-up time
        async function fetchWithRetry(url, options = {}, maxRetries = 5, initialDelay = 1000) {
            let lastError;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fetch(url, options);
                } catch (error) {
                    console.log(`Fetch attempt ${attempt + 1} failed:`, error);
                    lastError = error;
                    
                    // Wait before retrying with exponential backoff
                    if (attempt < maxRetries - 1) {
                        // Exponential backoff: 1s, 2s, 4s, 8s, etc.
                        const delay = initialDelay * Math.pow(2, attempt);
                        console.log(`Waiting ${delay}ms before retry ${attempt + 2}...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            // If we've exhausted all retries, throw the last error
            throw lastError;
        }

        // Add a function to get Member Services number based on insurance
        function getMemberServicesNumber(insurance) {
            const memberServicesMap = {
                "Centivo": "866-355-5999",
                "Oscar Health": "855-672-2755",
                "Emblem Health-GHI": "(800) 624-2414",
                "Magnacare": "(888) 799-6465",
                "Emblem Health HIP": "(800) 447-8255"
            };
            
            // Check if the insurance exists in our mapping
            for (const [insName, number] of Object.entries(memberServicesMap)) {
                if (insurance.includes(insName)) {
                    return number;
                }
            }
            
            // Default message if no match is found
            return "Please check the back of the Patient's Insurance ID card";
        }

        // Function to check if a provider is PCP eligible based on priority and location
        function isPcpEligible(providerName, location, insurance) {
            // Define providers who are never eligible for PCP (regardless of insurance)
            const neverEligibleProviders = [
                "Bene Aneke (Pyschiatry)",
                "Kamilah Bradley (Therapy)",
                "Tamara Henry (Pyschiatry)",
                "Brocha Newman (Nutrition)"
            ];
            
            // First check if provider is in the never-eligible list
            if (neverEligibleProviders.includes(providerName)) {
                return false;
            }
            
            // Define priority lists from the backend
            const priority_1 = [
                "Priti Jain", "Sandeep Jain", "Dayakishan Chahal", "Michael Ihemaguba", "Mansoor Farooki", 
                "Abel Infante", "Fazle Showon", "Barbara Phillips-Cole", "Rakesh Koul"
            ];
            
            const priority_2 = [
                "Rosetta Romero-Williams", "Shelly Twito", "Suraiya Chowdhury", 
                "Nickecha Redway", "Rainier Chirinos", "Mark Basaritmand", "Suresh Sagar"
            ];
            
            // For Fidelis, Emblem Health HIP, and Emblem Health-GHI, only priority_1 and priority_2 providers are PCP eligible
            if (insurance === "Fidelis" || 
                insurance === "Emblem Health HIP" || 
                insurance === "Emblem Health-GHI") {
                
                return priority_1.includes(providerName) || priority_2.includes(providerName);
            }
            
            // For Healthfirst insurance, check location-specific eligibility
            if (insurance.includes("Healthfirst")) {
                // Map of providers to their eligible locations
                const healthfirstProviderLocations = {
                    "Priti Jain": ["Hicksville", "Jackson Heights"],
                    "Sandeep Jain": ["Bartow"],
                    "Michael Ihemaguba": ["Bartow", "BX174"],
                    "Andie Spadaccini": ["Stuytown"],
                    "Abel Infante": ["Astoria", "Jackson Heights"],
                    "Dhara Rana": ["Bartow"],
                    "David Johnshon": ["Hicksville"],
                    "Fazle Showon": ["LONG ISLAND CITY", "BX174"],
                    "Homa Khowaja": ["Hicksville", "Mineola"],
                    "Kimberly Innocent": ["Stuytown"],
                    "Max Rubin": ["Crown Heights"],
                    "Nickecha Redway": ["Crown Heights"],
                    "Rainier Chirinos": ["Astoria", "Jackson Heights"],
                    "Dayakishan Chahal": ["Astoria", "Crown Heights", "Williamsburg"],
                    "Mansoor Farooki": ["Hicksville", "Jackson Heights"],
                    "Rosetta Romero-Williams": ["Jackson Heights", "Jamaica"],
                    "Suraiya Chowdhury": ["Hicksville"],
                    "Veronica Ramsaroop": ["Astoria", "Jackson Heights", "Hicksville"],
                    "Keith Haseley": ["Hicksville"],
                    "Ercole Petrungaro": ["Mineola"],
                    "Sara Park": ["Mineola"],
                    "Uchenna Egwuonwu": ["Mineola"]
                };
                
                // Check if provider is in the map and if current location is in their eligible locations
                if (healthfirstProviderLocations[providerName]) {
                    return healthfirstProviderLocations[providerName].includes(location);
                }
                
                // If provider is not in the map, they're not eligible for Healthfirst
                return false;
            }
            
            // For all other insurances, all providers are eligible (default behavior)
            return true;
        }

        // Modify the createProviderOptionsHTML function to include a search filter and PCP eligibility checkbox
        function createProviderOptionsHTML(data, site, insurance) {
            // Create a search input for providers
            const searchInputHTML = `
                <input type="text" id="providerSearch" class="provider-search" 
                       placeholder="Search for a provider..." 
                       onkeyup="filterProviders()">
                
                <div class="filter-toggle">
                    <input type="checkbox" id="showPcpEligibleOnly" onchange="filterProviders()">
                    <label for="showPcpEligibleOnly">Eligible for PCP Selection</label>
                </div>
            `;
            
            // Create the table with all providers
            return `
                <div class="right-section">
                    <div class="section-header">Provider Options</div>
                    ${searchInputHTML}
                    <div class="table-container">
                        <table id="providerTable">
                            <thead>
                                <tr>
                                    <th>Provider Name</th>
                                    <th>${insurance.toLowerCase().indexOf('healthfirst') !== -1 ? "Healthfirst ID" : "Provider NPI"}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.provider_options.map((provider) => `
                                    <tr data-pcp-eligible="${isPcpEligible(provider.name, site, insurance)}">
                                        <td>${provider.name}</td>
                                        <td>${provider.npi}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Update the filterProviders function to also filter by PCP eligibility
        function filterProviders() {
            const input = document.getElementById('providerSearch');
            const filter = input.value.toUpperCase();
            const showPcpEligibleOnly = document.getElementById('showPcpEligibleOnly').checked;
            const table = document.getElementById('providerTable');
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) { // Start from 1 to skip header row
                const tdName = tr[i].getElementsByTagName('td')[0];
                const tdNPI = tr[i].getElementsByTagName('td')[1];
                const isPcpEligible = tr[i].getAttribute('data-pcp-eligible') === 'true';
                
                if (tdName || tdNPI) {
                    const nameText = tdName.textContent || tdName.innerText;
                    const npiText = tdNPI.textContent || tdNPI.innerText;
                    
                    const matchesSearch = nameText.toUpperCase().indexOf(filter) > -1 || 
                                         npiText.toUpperCase().indexOf(filter) > -1;
                    
                    // Show row if it matches search AND (either PCP filter is off OR provider is PCP eligible)
                    if (matchesSearch && (!showPcpEligibleOnly || isPcpEligible)) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // Modify the fetchOptions function to include a centered retry button
        async function fetchOptions() {
            const site = document.getElementById("site").value;
            const insurance = document.getElementById("insurance").value;
            const isUnder18 = document.getElementById("isUnder18").checked;
            const isFollowUp = document.getElementById("isFollowUp").checked;

            if (!site || !insurance) {
                alert("Please select both site and insurance!");
                return;
            }

            // Show loading spinner
            document.getElementById("output").innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Retreiving information and Providers...</div>
                </div>
            `;

            // Predefined response for "OTHER" insurance
            if (insurance === "OTHER") {
                const predefinedOtherResponse = {
                    facility_options: {
                        facilities: [],
                        message: "Unable to determine facility options."
                    },
                    pcp_change_requirement: {
                        details: "Insurance not in our current system."
                    },
                    feedback_link: "https://forms.gle/ME2mKmVALXh4iDKWA"
                };

                const outputHTML = `
                    <div class="section-header">Insurance Inquiry</div>
                    <p>${predefinedOtherResponse.pcp_change_requirement.details}</p>
                    
                    <div class="feedback-section">
                        <div class="section-header">Next Steps</div>
                        <p>We recommend calling the Member Services number on the back of the patient's insurance card.</p>
                        
                        <div class="section-header">Help Us Improve</div>
                        <p>Can't find your insurance?</p>
                        <p>We want to hear from you!</p>
                        <a href="${predefinedOtherResponse.feedback_link}" 
                        target="_blank" 
                        class="form-link">
                        Submit Feedback
                        </a>
                    </div>
                `;

                document.getElementById("output").innerHTML = outputHTML;
                return; // Stop further execution
            }

            try {
                const response = await fetch(`/test?location=${encodeURIComponent(site)}&insurance=${encodeURIComponent(insurance)}&isUnder18=${isUnder18}&isFollowUp=${isFollowUp}`);
                
                const data = await response.json();

                if (data.error) {
                    document.getElementById("output").innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }

                // Add PCP Change section with a cleaner design
                let pcpChangeHTML = '';
                if (!isUnder18 && data.pcp_change_requirement) {
                    const requiresThreeWayCall = data.pcp_change_requirement.details && 
                        data.pcp_change_requirement.details.includes("3-way call required");
                    
                    const hasPcpChangeForm = data.pcp_change_requirement.details && 
                        (data.pcp_change_requirement.details.includes("Insurance has PCP Change Form") || 
                         data.pcp_change_requirement.details === "Insurance has PCP Change Form.");
                    
                    // Start with the standard PCP change requirement information
                    pcpChangeHTML = `
                        <div class="section-header">PCP Change Requirement</div>
                        <p><strong>${data.pcp_change_requirement.details}</strong></p>
                        
                        ${requiresThreeWayCall ? `
                            <p><strong>Member Services Number:</strong> ${getMemberServicesNumber(insurance)}</p>
                        ` : ''}
                        
                        ${(insurance.includes("UHC") || insurance.includes("United Healthcare")) ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>Choice Plus</li>
                                <li>LPPO-UNITEDHEALTHCARE GROUP MEDICARE ADVANTAGE</li>
                                <li>UHC Dual Complete NY-S001 (PPO D-SNP)</li>
                                <li>POS Choice Plus</li>
                                <li>Choice EPO</li>
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        ` : ''}
                        
                        ${insurance.includes("Oxford") ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>Liberty Network</li>
                                <li>Freedom Network</li>
                            </ul>
                        ` : ''}

                        ${insurance.includes("Aetna") ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>OPEN ACCESS AETNA SELECT</li>
                                <li>OPEN ACCESS MANAGED CHOICE (MC)</li>
                                <li>AETNA CHOICE POS II</li>
                                <li>OPEN ACCESS ELECT CHOICE (OAEPO)</li>
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        ` : ''}

                        ${(insurance.includes("BC Empire") || insurance.includes("BCBS Empire")) ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>BLUE ACCESS PPO NY</li>
                                <li>NJ PPO ALTNET HORIZON MAN CARE 36K0</li>
                                <li>EPO Plan</li>
                                <li>Direct POS</li>
                                <li>Empire Blue Access Gated EPO</li>
                                <li>FEP BLUE/FEDERAL</li>
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        ` : ''}

                        ${insurance.includes("Wellcare") ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>SIMPLE OPEN (PPO)</li>
                            </ul>
                        ` : ''}

                        ${insurance.includes("Magnacare") ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        ` : ''}

                        ${insurance.includes("Oscar Health") ? `
                            <p style="margin-bottom: 5px;">If the patient has one of these plans, they do not need PCP Change:</p>
                            <ul style="text-align: left; padding-left: 20px; margin-top: 5px;">
                                <li>Preferred Provider Organization (PPO)</li>
                            </ul>
                        ` : ''}
                    `;
                    
                    // Add Medicare-specific or form-specific information
                    if (insurance === "Medicare") {
                        pcpChangeHTML += `
                            <div class="section-header">PCP Change Form</div>
                            <p>
                                • If you want to send Healow Sign, 
                                <a href="https://docs.google.com/presentation/d/1VyVUQb-XBqmuwI4JGZyYN_3zwZD0O-SYDb6V16E6DcY/edit#slide=id.g3086a10fc51_0_189" 
                                target="_blank" 
                                class="form-link">Healow Sign Process</a>
                            </p>
                            <p>If you want to print out the required forms, you can access them below:</p>
                            <p>
                                • <a href="https://drive.google.com/file/d/1YI4b9ZOTKDTM0SsGLJzytdTO24zTNE2E/view?usp=drive_link" 
                                target="_blank" 
                                class="form-link">Voluntary Alignment Form</a>
                            </p>
                            <p>
                                • <a href="https://drive.google.com/file/d/1LbekCRNLZsXzzNdXS0edFVZCmjNZwnA5/view?usp=sharing" 
                                target="_blank" 
                                class="form-link">SDoH Form</a>
                            </p>
                        `;
                    } else if (hasPcpChangeForm || data.pcp_change_requirement?.form_link) {
                        pcpChangeHTML += `
                            <div class="section-header">PCP Change Form</div>
                            <div class="phone-submission">
                                <p>If you want to send the 
                                    <a href="https://checkin.naomedical.com"
                                    target="_blank" 
                                    class="form-link">PCP Change Portal Link</a>       
                                    to the patient, please enter their phone number below,
                                </p>
                                <input type="tel" id="phoneNumber" class="phone-input" 
                                    placeholder="(XXX) XXX-XXXX"
                                    maxlength="14">
                                <button onclick="submitPhoneNumber('${insurance}')">Submit</button>
                                <div id="phoneSubmissionMessage"></div>
                            </div>
                            
                            <p style="margin-top: 15px; margin-bottom: 5px;">
                                • If you want to send Healow Sign, 
                                <a href="https://docs.google.com/presentation/d/1VyVUQb-XBqmuwI4JGZyYN_3zwZD0O-SYDb6V16E6DcY/edit#slide=id.g3086a10fc51_0_189" 
                                target="_blank" 
                                class="form-link">Healow Sign Process</a>
                            </p>
                            <p style="margin-top: 5px; margin-bottom: 5px;">
                                • If you want to print out the form, 
                                <a href="${data.pcp_change_requirement.form_link || '#'}" 
                                target="_blank" 
                                class="form-link">PCP Change Form</a>
                            </p>
                        `;
                    }
                }

                // Use the new function to create provider options HTML
                const providerOptionsHTML = createProviderOptionsHTML(data, site, insurance);
                
                document.getElementById("output").innerHTML = `
                    <div class="content-wrapper">
                        <div class="left-section">
                            <div class="section-header">Facility Options</div>
                            ${data.facility_options.message}
                            
                            ${pcpChangeHTML}
                        </div>
                        ${providerOptionsHTML}
                    </div>
                `;
                
                // Setup phone formatting after content is added
                setTimeout(setupPhoneNumberFormatting, 100);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById("output").innerHTML = `
                    <div class="error-container">
                        <div class="error-message">
                            An error occurred while fetching data. The database may be spinning up.
                        </div>
                        <button onclick="fetchOptions()" class="retry-button">Retry</button>
                    </div>`;
            }
        }

        function handleSubmit() {
            // Track the button click in Google Analytics
            gtag('event', 'button_click', {
                'event_category': 'Engagement',
                'event_label': 'Submit Button'
            });
            
            // Call the original function
            fetchOptions();
        }
    </script>
</head>
<body>
    <div class="page-container">
        <div class="header">
            <div class="header-container">
                <img src="/static/nao.logo.png" alt="Nao Medical Logo" class="header-logo">
                <h1 class="header-title">Provider Look Up Tool</h1>
            </div>
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="filters">
                    <div class="filter-group">
                        <label class="select-label" for="site">Location:</label>
                        <select id="site">
                            <option value="">Select Location</option>
                            <option value="Astoria">Astoria</option>
                            <option value="Bartow">Bartow</option>
                            <option value="BX174">BX174</option>
                            <option value="Corona">Corona</option>
                            <option value="Crown Heights">Crown Heights</option>
                            <option value="Hicksville">Hicksville</option>
                            <option value="Jackson Heights">Jackson Heights</option>
                            <option value="Jamaica">Jamaica</option>
                            <option value="LIC">Long Island City</option>
                            <option value="Manhattan">Manhattan</option>
                            <option value="Mineola">Mineola</option>
                            <option value="Stuytown">Stuytown</option>
                            <option value="Williamsburg">Williamsburg</option>
                            <option value="Nutrition">Nao Med - Nutrition</option>
                            <option value="PSYCH">Nao Med - Psych</option>
                            <option value="Televisit">Televisit</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="select-label" for="insurance">Insurance:</label>
                        <select id="insurance">
                            <option value="">Select Insurance</option>
                            <option value="1199 National Benefits Fund">1199 National Benefits Fund</option>
                            <option value="Aetna">Aetna</option>
                            <option value="BC Empire">BC Empire</option>
                            <option value="BCBS Empire">BCBS Empire</option>
                            <option value="Centivo">Centivo</option>
                            <option value="Cigna">Cigna</option>
                            <option value="Elder Plan">Elder Plan</option>
                            <option value="Emblem Health-GHI">Emblem Health-GHI</option>
                            <option value="Emblem Health HIP">Emblem Health HIP</option>
                            <option value="Fidelis">Fidelis</option>
                            <option value="First Health (Aetna)">First Health (Aetna)</option>
                            <option value="Healthfirst Medicare">Healthfirst Medicare</option>
                            <option value="Healthfirst Medicaid">Healthfirst Medicaid</option>
                            <option value="Healthfirst Other LOB">Healthfirst Other LOB</option>
                            <option value="HEALTHPLUS LLC">HEALTHPLUS LLC</option>
                            <option value="Humana">Humana</option>
                            <option value="Magnacare">Magnacare</option>
                            <option value="Medicaid">Medicaid</option>
                            <option value="Medicare">Medicare</option>
                            <option value="Metroplus">Metroplus</option>
                            <option value="Affinity">Molina Affinity</option>
                            <option value="MVP Health Plan">MVP Health Plan</option>
                            <option value="Multiplan / PHCS">Multiplan / PHCS</option>
                            <option value="Oscar Health">Oscar Health</option>
                            <option value="Oxford">Oxford Health Plan</option>
                            <option value="Tricare Humana Military">Tricare Humana Military</option>
                            <option value="UHC Medicare">United Healthcare Medicare</option>
                            <option value="UHC Medicaid NY">United Healthcare Medicaid NY</option>
                            <option value="UHC other LOB">United Healthcare other LOB</option>
                            <option value="WEBTPA">WEBTPA</option>
                            <option value="Wellcare">Wellcare</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-container">
                        <div class="checkbox-item">
                            <input type="checkbox" id="isUnder18">
                            <label for="isUnder18">Is patient under the age of 18?</label>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="isFollowUp">
                            <label for="isFollowUp">Is this a follow-up appointment?</label>
                        </div>
                    </div>
                    
                    <button onclick="handleSubmit()" class="submit-button">Submit</button>
                </div>

                <div class="feedback-section">
                    <div class="section-header">Help Us Improve</div>
                    <p>Can't find the insurance or provider you're looking for? We want to hear from you!</p>
                    <a href="https://forms.gle/ME2mKmVALXh4iDKWA" 
                       target="_blank" 
                       class="form-link">
                       Submit Feedback
                    </a>
                </div>
            </div>

            <div class="results" id="output">
                <!-- This content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>
